# Creating the SQL tables:

CREATE TABLE air_pollution (
    latitude DECIMAL(6,4),
    longitude DECIMAL(6,4),
    aqi INT,
    co DECIMAL(8,2),
    no DECIMAL(8,2),
    no2 DECIMAL(8,2),
    o3 DECIMAL(8,2),
    so2 DECIMAL(8,2),
    pm2_5 DECIMAL(8,2),
    pm10 DECIMAL(8,2),
    nh3 DECIMAL(8,2),
    dt TIMESTAMP
);

CREATE TABLE cities (
    country varchar(50),
	city varchar(50),
	latitude DECIMAL(6,4)
	longitude DECIMAL(6,4)
);

# Querying the most polluted cities from 2021:

SELECT 	SUM(AQI_COUNT),
		CITY
FROM
	(SELECT EXTRACT(YEAR FROM DATE_TIME) AS YEAR,
		C.COUNTRY,
		C.CITY,
		COUNT(A.AIR_QUALITY_INDEX) AS AQI_COUNT
FROM AIR_POLLUTION AS A
JOIN CITIES AS C ON A.LATITUDE = C.LATITUDE
		AND A.LONGITUDE = C.LONGITUDE
WHERE EXTRACT(YEAR FROM DATE_TIME) = '2021'
		AND A.AIR_QUALITY_INDEX = 5
GROUP BY COUNTRY,
		 CITY,
		 AIR_QUALITY_INDEX,
	 	 DATE_TIME
ORDER BY AIR_QUALITY_INDEX DESC) AS MAIN
GROUP BY CITY
ORDER BY SUM DESC;

#Also the least polluted/healthiest cities:

SELECT 	SUM(AQI_COUNT),
		CITY
FROM
	(SELECT EXTRACT(YEAR FROM DATE_TIME) AS YEAR,
		C.COUNTRY,
		C.CITY,
		COUNT(A.AIR_QUALITY_INDEX) AS AQI_COUNT
FROM AIR_POLLUTION AS A
JOIN CITIES AS C ON A.LATITUDE = C.LATITUDE
		AND A.LONGITUDE = C.LONGITUDE
WHERE EXTRACT(YEAR FROM DATE_TIME) = '2021'
		AND A.AIR_QUALITY_INDEX < 2
GROUP BY COUNTRY,
		 CITY,
		 AIR_QUALITY_INDEX,
	 	 DATE_TIME
ORDER BY AIR_QUALITY_INDEX DESC) AS MAIN
GROUP BY CITY
ORDER BY SUM DESC;

# If we want to have a look and compare seasonsal pollution data here is a query for that too:

SELECT 	SUM(AQI_COUNT),
		CITY,
		COUNTRY
FROM
	(SELECT EXTRACT(YEAR FROM DATE_TIME) AS YEAR,
		C.COUNTRY,
		C.CITY,
		COUNT(A.AIR_QUALITY_INDEX) AS AQI_COUNT
FROM AIR_POLLUTION AS A
JOIN CITIES AS C ON A.LATITUDE = C.LATITUDE
		AND A.LONGITUDE = C.LONGITUDE
WHERE EXTRACT(YEAR FROM DATE_TIME) = '2021'
	  	AND EXTRACT(MONTH FROM DATE_TIME) IN(3,4,5)
		AND A.AIR_QUALITY_INDEX < 2
GROUP BY COUNTRY,
		 CITY,
		 AIR_QUALITY_INDEX,
	 	 DATE_TIME
ORDER BY AIR_QUALITY_INDEX DESC) AS MAIN_QUERY
GROUP BY CITY, COUNTRY
ORDER BY SUM DESC;

#Yearly avarage PM2.5:

COUNTRY,
		AVG(AVG_PM2_5)
FROM (
SELECT  EXTRACT(YEAR FROM DATE_TIME) AS YEAR,
		C.COUNTRY,
		C.CITY,
		AVG(A.PM2_5) AS AVG_PM2_5
FROM AIR_POLLUTION AS A
JOIN CITIES AS C ON A.LATITUDE = C.LATITUDE
		AND A.LONGITUDE = C.LONGITUDE
WHERE EXTRACT(YEAR FROM DATE_TIME) = '2021'
GROUP BY COUNTRY,
		 CITY,
		 PM2_5,
	 	 DATE_TIME
) AS MAIN_QUERY
GROUP BY CITY,
		COUNTRY
ORDER BY AVG(AVG_PM2_5) DESC;
